<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MySQL备份与恢复 | 舍沙の窝</title><meta name="author" content="Sesa·Ananta"><meta name="copyright" content="Sesa·Ananta"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MySQL备份与恢复一、逻辑备份1、回顾什么是逻辑备份逻辑备份就是把数据库、数据表或者数据进行导出，导出到一个文本文件中。 2、逻辑备份工具mysqldump：提供全库级、数据库级别以及表级别的数据备份 mysqldump + binlog二进制日志实现增量备份 3、逻辑的导出与导入☆ 导出（数据备份）无论是什么存储引擎，以下方式本身是一种数据导出的方法，同时可以用来辅助备份，它可以对一个表的其中">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL备份与恢复">
<meta property="og:url" content="http://sesaananta.github.io/posts/7105.html">
<meta property="og:site_name" content="舍沙の窝">
<meta property="og:description" content="MySQL备份与恢复一、逻辑备份1、回顾什么是逻辑备份逻辑备份就是把数据库、数据表或者数据进行导出，导出到一个文本文件中。 2、逻辑备份工具mysqldump：提供全库级、数据库级别以及表级别的数据备份 mysqldump + binlog二进制日志实现增量备份 3、逻辑的导出与导入☆ 导出（数据备份）无论是什么存储引擎，以下方式本身是一种数据导出的方法，同时可以用来辅助备份，它可以对一个表的其中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://sesaananta.github.io/img/%E5%A4%B4%E5%83%8F.png">
<meta property="article:published_time" content="2023-12-23T02:00:18.000Z">
<meta property="article:modified_time" content="2024-01-15T08:37:14.299Z">
<meta property="article:author" content="Sesa·Ananta">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="学习">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://sesaananta.github.io/img/%E5%A4%B4%E5%83%8F.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://sesaananta.github.io/posts/7105.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/favicon-16x16.png"/><link rel="mask-icon" href="/img/siteicon/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL备份与恢复',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-15 16:37:14'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/bolan.css?1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/bb/showbb_in_index.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/album/"><i class="fa-fw fas fa-images"></i><span> 相册集</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page" href="/essay/"><i class="fa-fw fas fa-message"></i><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page" href="/website/"><i class="fa-fw fas fa-network-wired"></i><span> 网站</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 单链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 语吾</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/%E8%9B%87%E9%BE%99.png')"><nav id="nav"><span id="blog-info"><a href="/" title="舍沙の窝"><span class="site-name">舍沙の窝</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/album/"><i class="fa-fw fas fa-images"></i><span> 相册集</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page" href="/essay/"><i class="fa-fw fas fa-message"></i><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page" href="/website/"><i class="fa-fw fas fa-network-wired"></i><span> 网站</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 单链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 语吾</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL备份与恢复</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-23T02:00:18.000Z" title="发表于 2023-12-23 10:00:18">2023-12-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-15T08:37:14.299Z" title="更新于 2024-01-15 16:37:14">2024-01-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/linux/">linux</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/linux/mysql/">mysql</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL备份与恢复"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="MySQL备份与恢复"><a href="#MySQL备份与恢复" class="headerlink" title="MySQL备份与恢复"></a>MySQL备份与恢复</h1><h1 id="一、逻辑备份"><a href="#一、逻辑备份" class="headerlink" title="一、逻辑备份"></a>一、逻辑备份</h1><h2 id="1、回顾什么是逻辑备份"><a href="#1、回顾什么是逻辑备份" class="headerlink" title="1、回顾什么是逻辑备份"></a>1、回顾什么是逻辑备份</h2><p>逻辑备份就是把数据库、数据表或者数据进行导出，导出到一个文本文件中。</p>
<h2 id="2、逻辑备份工具"><a href="#2、逻辑备份工具" class="headerlink" title="2、逻辑备份工具"></a>2、逻辑备份工具</h2><p>mysqldump：提供全库级、数据库级别以及表级别的数据备份</p>
<p>mysqldump + binlog二进制日志实现增量备份</p>
<h2 id="3、逻辑的导出与导入"><a href="#3、逻辑的导出与导入" class="headerlink" title="3、逻辑的导出与导入"></a>3、逻辑的导出与导入</h2><h3 id="☆-导出（数据备份）"><a href="#☆-导出（数据备份）" class="headerlink" title="☆ 导出（数据备份）"></a>☆ 导出（数据备份）</h3><p>无论是什么存储引擎，以下方式本身是一种数据导出的方法，同时可以用来辅助备份，它可以对一个表的其中一列或者某几列做备份。备份的是&#x3D;&#x3D;数据记录。&#x3D;&#x3D;</p>
<p>案例：把tb_student数据表中的数据记录进行逻辑导出</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password:<span class="number">123</span></span><br><span class="line">mysql&gt; <span class="built_in">select</span> * into outfile <span class="string">&#x27;/tmp/sqlbak/tb_student.txt&#x27;</span> from db_itheima.tb_student;</span><br><span class="line"></span><br><span class="line">ERROR <span class="number">1290</span> (HY000): The MySQL server is running with the <span class="literal">--secure-file-priv</span> option so it cannot execute this statement</span><br></pre></td></tr></table></figure>

<p>出现以上问题的主要原因在于我们没有指定MySQL逻辑导出时指定的路径</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim my.cnf</span></span><br><span class="line">[<span class="type">mysqld</span>]</span><br><span class="line">...</span><br><span class="line">secure_file_priv=/tmp/sqlbak/</span><br><span class="line"></span><br><span class="line"><span class="comment"># service mysql_3306 restart</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">select</span> * into outfile <span class="string">&#x27;/tmp/sqlbak/tb_student.txt&#x27;</span> from db_itheima.tb_student;</span><br><span class="line">ERROR <span class="number">1</span> (HY000): Can<span class="string">&#x27;t create/write to file &#x27;</span>/tmp/sqlbak/tb_student.txt<span class="string">&#x27; (Errcode: 13 - Permission denied)</span></span><br></pre></td></tr></table></figure>

<p>出现以上问题的主要原因在于mysql账号对&#x2F;tmp&#x2F;sqlbak没有写入权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setfacl -m u:mysql:rwx /tmp/sqlbak</span></span><br></pre></td></tr></table></figure>

<h3 id="☆-导入（数据还原）"><a href="#☆-导入（数据还原）" class="headerlink" title="☆ 导入（数据还原）"></a>☆ 导入（数据还原）</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password:<span class="number">123</span></span><br><span class="line">mysql&gt; load <span class="keyword">data</span> local infile <span class="string">&#x27;/tmp/sqlbak/tb_student.txt&#x27;</span> into table tb_student;</span><br><span class="line">或</span><br><span class="line"><span class="comment"># mysqlimport dbname /path/file -p  =&gt;   要求，导出的文件必须和数据表名称完全一致</span></span><br><span class="line">例如：</span><br><span class="line"><span class="comment"># mysqlimport db_itheima /tmp/sqlbak/tb_student.txt -p</span></span><br><span class="line">Enter password:<span class="number">123</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>典型应用场景：可以把一些规则的文本文件导入到数据表中</p>
</blockquote>
<p>案例：把&#x2F;etc&#x2F;passwd文件中的数据导入到password数据表中</p>
<p>第一步：创建一个password数据表，password是mysql保留关键字，建议使用&#96;&#96;两个反撇号括起来</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use db_itheima;</span><br><span class="line">mysql&gt; CREATE TABLE `password` (</span><br><span class="line">  `uname` varchar(<span class="number">50</span>) DEFAULT NULL,</span><br><span class="line">  `pass` char(<span class="number">2</span>) DEFAULT NULL,</span><br><span class="line">  `uid` int(<span class="number">11</span>) DEFAULT NULL,</span><br><span class="line">  `gid` int(<span class="number">11</span>) DEFAULT NULL,</span><br><span class="line">  `comment` varchar(<span class="number">255</span>) DEFAULT NULL,</span><br><span class="line">  `home` varchar(<span class="number">50</span>) DEFAULT NULL,</span><br><span class="line">  `shell` varchar(<span class="number">50</span>) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure>

<p>第二步：把&#x2F;etc&#x2F;passwd文件拷贝到&#x2F;tmp&#x2F;sqlbak目录下，起名叫password.txt</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cp /etc/passwd /tmp/sqlbak/password.txt</span></span><br></pre></td></tr></table></figure>

<p>第三步：使用mysqlimport把password.txt文件中的内容写入到数据表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysqlimport db_itheima --fields-terminated-by=&#x27;:&#x27; --lines-terminated-by=&#x27;\n&#x27; /tmp/sqlbak/password.txt -p</span></span><br><span class="line"></span><br><span class="line">选项说明</span><br><span class="line"><span class="literal">--fields-terminated-by</span>=<span class="string">&#x27;:&#x27;</span>，指定导出文件的分隔符为冒号:</span><br><span class="line"><span class="literal">--lines-terminated-by</span>=<span class="string">&#x27;\n&#x27;</span>，指定每一行的结尾使用的符号,\n代表换行符</span><br></pre></td></tr></table></figure>

<h2 id="4、扩展：逻辑备份还原小工具（支持远程连接）"><a href="#4、扩展：逻辑备份还原小工具（支持远程连接）" class="headerlink" title="4、扩展：逻辑备份还原小工具（支持远程连接）"></a>4、扩展：逻辑备份还原小工具（支持远程连接）</h2><p>MySQL其实还支持很多管理软件（Windows版）：MySQL-Front、Navicat</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829112341086.png" alt="image-20200829112341086"></p>
<p>第一步：选择MySQL连接</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829112453585.png" alt="image-20200829112453585"></p>
<p>第二步：输入MySQL连接信息</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829112649593.png" alt="image-20200829112649593"></p>
<p>第三步：功能演示&#x3D;&gt;创建数据库、创建数据表、插入数据…</p>
<p>第四步：数据库的备份与还原</p>
<p>① 逻辑的导出与导入</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829113438778.png" alt="image-20200829113438778"></p>
<p>② 数据表的备份与还原</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829115157369.png" alt="image-20200829115157369"></p>
<p>③ 数据库的备份与还原</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829115303550.png" alt="image-20200829115303550"></p>
<h1 id="二、物理备份"><a href="#二、物理备份" class="headerlink" title="二、物理备份"></a>二、物理备份</h1><h2 id="1、xtrabackup备份介绍"><a href="#1、xtrabackup备份介绍" class="headerlink" title="1、xtrabackup备份介绍"></a>1、xtrabackup备份介绍</h2><p>####㈠ xtrabackup优缺点</p>
<p><strong>优点：</strong> </p>
<ol>
<li>备份过程&#x3D;&#x3D;快速、可靠(&#x3D;&#x3D;因为是物理备份)；</li>
<li>支持&#x3D;&#x3D;增量备份&#x3D;&#x3D;，更为灵活</li>
<li>备份过程<strong>不会打断正在执行的事务</strong>；</li>
<li>能够基于压缩等功能节约磁盘空间和流量；</li>
<li>自动实现备份检验；</li>
<li>&#x3D;&#x3D;还原速度快&#x3D;&#x3D;；</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>只能对&#x3D;&#x3D;innodb表增量备份&#x3D;&#x3D;，myisam表增量备份时是全备</li>
<li>innobackupex备份MyISAM表之前要对全库进行加READ LOCK，阻塞写操作，若备份是在从库上进行的话会影响主从同步，造成延迟。对InnoDB表备份不会阻塞读写。</li>
</ol>
<p>####㈡ &#x3D;&#x3D;xtrabackup备份原理&#x3D;&#x3D;</p>
<ol>
<li>innobackupex首先会&#x3D;&#x3D;启动&#x3D;&#x3D;一个&#x3D;&#x3D;xtrabackup_log&#x3D;&#x3D;后台检测的进程，实时检测mysql的&#x3D;&#x3D;redo log&#x3D;&#x3D;的变化，一旦发现redo有新的日志写入，立刻将日志写入到日志文件&#x3D;&#x3D;xtrabackup_log&#x3D;&#x3D;中。</li>
<li>&#x3D;&#x3D;物理&#x3D;&#x3D;拷贝&#x3D;&#x3D;innodb的数据文件和系统表空间文件idbdata1&#x3D;&#x3D;到对应的以默认时间戳为备份目录的地方</li>
<li>复制结束后，执行&#x3D;&#x3D;flush table with read lock&#x3D;&#x3D;操作进行全库锁表准备备份非InnoDB文件</li>
<li>物理复制.frm .myd .myi等非InnoDB引擎文件到备份目录</li>
<li>查看二进制日志的位置</li>
<li>解锁表unlock tables</li>
<li>&#x3D;&#x3D;停止&#x3D;&#x3D;xtrabackup_log进程</li>
</ol>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829144019688.png" alt="image-20200829144019688"></p>
<p>扩展：redo log日志？</p>
<p>事务日志或称redo日志，在mysql中默认以ib_logfile0,ib_logfile1名称存在。</p>
<p>####㈢ &#x3D;&#x3D;xtrabackup备份恢复原理&#x3D;&#x3D;</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829145320869.png" alt="image-20200829145320869"></p>
<p><strong>具体文字描述如下（了解）：</strong></p>
<ul>
<li>在InnoDB内部会维护一个redo日志文件，我们也可以叫做事务日志文件。事务日志会存储每一个InnoDB表数据的记录修改。当InnoDB启动时，InnoDB会检查数据文件和事务日志，并执行两个步骤：它应用（前滚）已经提交的事务日志到数据文件，并将修改过但没有提交的数据进行回滚操作。</li>
<li>xtrabackup在启动时会记住log sequence number（LSN），并且复制所有的数据文件。复制过程需要一些时间，所以这期间如果数据文件有改动，那么将会使数据库处于一个不同的时间点。这时，xtrabackup会运行一个后台进程，用于监视事务日志，并从事务日志复制最新的修改。xtrabackup必须持续的做这个操作，是因为事务日志是会轮转重复的写入，并且事务日志可以被重用。所以xtrabackup自启动开始，就不停的将事务日志中每个数据文件的修改都记录下来。</li>
<li>上面就是xtrabackup的备份过程。接下来是准备（prepare）过程。在这个过程中，xtrabackup使用之前复制的事务日志，对各个数据文件执行灾难恢复（就像MySQL刚启动时要做的一样）。当这个过程结束后，数据库就可以做恢复还原了。</li>
<li>以上的过程在xtrabackup的编译二进制程序中实现。程序innobackupex可以允许我们备份MyISAM表和frm文件从而增加了便捷和功能。Innobackupex会启动xtrabackup，直到xtrabackup复制数据文件后，然后执行FLUSH TABLES WITH READ LOCK来阻止新的写入进来并把MyISAM表数据刷到硬盘上，之后复制MyISAM数据文件，最后释放锁。</li>
<li>备份MyISAM和InnoDB表最终会处于一致，在准备（prepare）过程结束后，InnoDB表数据已经前滚到整个备份结束的点，而不是回滚到xtrabackup刚开始时的点。这个时间点与执行FLUSH TABLES WITH READ LOCK的时间点相同，所以MyISAM表数据与InnoDB表数据是同步的。类似Oracle的recover和restore，InnoDB的prepare过程可以称为recover（恢复），MyISAM的数据复制过程可以称为restore（还原）。 </li>
<li>&#x3D;&#x3D;Mysql5.7.3以后开启二进制日志需要加上server-id选项，不然报错&#x3D;&#x3D;</li>
</ul>
<h2 id="2、获取xtrabackup备份工具"><a href="#2、获取xtrabackup备份工具" class="headerlink" title="2、获取xtrabackup备份工具"></a>2、获取xtrabackup备份工具</h2><p>网站域名：<a target="_blank" rel="noopener" href="http://www.percona.com/">http://www.percona.com</a></p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829150625283.png" alt="image-20200829150625283"></p>
<h2 id="3、xtabackup软件的安装"><a href="#3、xtabackup软件的安装" class="headerlink" title="3、xtabackup软件的安装"></a>3、xtabackup软件的安装</h2><p>第一步：上传软件包及依赖库到Linux服务器端</p>
<p>第二步：安装依赖库</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh libev-4.15-3.el7.x86_64.rpm</span></span><br></pre></td></tr></table></figure>

<p>第三步：安装xtrabackup软件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm -y</span></span><br><span class="line"><span class="comment"># rpm -ql percona-xtrabackup-24</span></span><br></pre></td></tr></table></figure>

<h2 id="4、xtrabackup全库备份与恢复"><a href="#4、xtrabackup全库备份与恢复" class="headerlink" title="4、xtrabackup全库备份与恢复"></a>4、xtrabackup全库备份与恢复</h2><p>备份核心思路：</p>
<p>① 使用innobackupex对数据库中的所有库进行全量备份，备份完成后，其不能立即进行数据恢复（数据不完整，缺少12:00 ~ 12:30这个过程中的数据）</p>
<p>② &#x3D;&#x3D;预备阶段&#x3D;&#x3D;，备份过程中产生的xtrabackup_log&#x3D;&#x3D;应用到全量备份集&#x3D;&#x3D;</p>
<p>③ 模拟故障（删除数据） &#x3D;&gt;   rm  -rf   data&#x2F;*</p>
<p>④ 动员运维工程师进行全库恢复</p>
<p>⑤ 测试验证</p>
<p>第一步：准备数据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database db_itheima default charset=utf8;</span><br><span class="line">mysql&gt; use db_itheima;</span><br><span class="line">mysql&gt; create table t1(id int,name varchar(<span class="number">10</span>)) engine=myisam;</span><br><span class="line">mysql&gt; insert into t1 values (<span class="number">1</span>,<span class="string">&#x27;吕布&#x27;</span>);</span><br><span class="line">mysql&gt; create table t2(id int,name varchar(<span class="number">10</span>)) engine=innodb;</span><br><span class="line">mysql&gt; insert into t2 values (<span class="number">1</span>,<span class="string">&#x27;貂蝉&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>第二步：专门准备一个数据库备份账号，开通相应权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">创建备份用户admin，并授予相应权限</span><br><span class="line">mysql&gt; grant reload,<span class="keyword">process</span>,lock tables,replication client on *.* to <span class="string">&#x27;admin&#x27;</span><span class="string">@&#x27;localhost&#x27; identified by &#x27;123&#x27;;</span></span><br><span class="line"><span class="string">mysql&gt; flush privileges;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">说明：</span></span><br><span class="line"><span class="string">在数据库中需要以下权限：</span></span><br><span class="line"><span class="string">RELOAD和LOCK TABLES权限:为了执行FLUSH TABLES WITH READ LOCK</span></span><br><span class="line"><span class="string">REPLICATION CLIENT权限：为了获取binary log位置</span></span><br><span class="line"><span class="string">PROCESS权限：显示有关在服务器中执行的线程的信息（即有关会话执行的语句的信息），允许使用SHOW ENGINE</span></span><br></pre></td></tr></table></figure>

<p>第三步：使用innobackupex工具进行全库备份</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex --user=admin --password=123 /full_xtrabackup</span></span><br><span class="line">说明：备份目录默认会自动创建，也可以手动创建</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the backup run completes successfully.</span><br><span class="line">           At the <span class="keyword">end</span> of a successful backup run innobackupex</span><br><span class="line">           prints <span class="string">&quot;completed OK!&quot;</span>.</span><br></pre></td></tr></table></figure>

<p>第一次运行报错：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">200829</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">59</span>  version_check Connecting to MySQL server with DSN <span class="string">&#x27;dbi:mysql:;mysql_read_default_group=xtrabackup&#x27;</span> as <span class="string">&#x27;admin&#x27;</span>  (<span class="keyword">using</span> password: YES).</span><br><span class="line">Failed to connect to MySQL server: DBI connect(<span class="string">&#x27;;mysql_read_default_group=xtrabackup&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>,...) failed: Can<span class="string">&#x27;t connect to local MySQL server through socket &#x27;</span>/var/lib/mysql/mysql.sock<span class="string">&#x27; (2) at - line 1314.</span></span><br><span class="line"><span class="string">200829 15:48:59 Connecting to MySQL server host: localhost, user: admin, password: set, port: not set, socket: not set</span></span><br><span class="line"><span class="string">Failed to connect to MySQL server: Can&#x27;</span>t connect to local MySQL server through socket <span class="string">&#x27;/var/lib/mysql/mysql.sock&#x27;</span> (<span class="number">2</span>).</span><br></pre></td></tr></table></figure>

<p>出现以上问题的主要原因在于我们的mysql.sock并不在&#x2F;var&#x2F;lib&#x2F;mysql目录下。为什么其会自动连接&#x2F;var&#x2F;lib&#x2F;mysql目录下的mysql.sock呢？</p>
<p>原因1：可能在&#x2F;etc目录下还有my.cnf文件，影响了innobackupex的执行。</p>
<p>原因2：innobackupex拥有自己的默认配置，默认读取了&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock文件</p>
<p>解决方案：</p>
<p>方案1：把你的套接字文件创建一个软链接，放置于&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock文件中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/lib/mysql</span></span><br><span class="line"><span class="comment"># ln -s /tmp/mysql.sock /var/lib/mysql/mysql.sock</span></span><br></pre></td></tr></table></figure>

<p>方案2：在innobackupex中添加一个-S选项，执行套接字</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex -S /tmp/mysql.sock --user=admin --password=123 /full_xtrabackup</span></span><br></pre></td></tr></table></figure>

<p>第四步：预备阶段，把备份这段时间内产生的日志整合到全量备份中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex --user=admin --password=123 --apply-log /full_xtrabackup/2020-08-29_15-59-22</span></span><br></pre></td></tr></table></figure>

<p>第五步：模拟数据库故障</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rm -rf /mysql_3306/data/*</span></span><br><span class="line"><span class="comment"># pkill mysqld</span></span><br></pre></td></tr></table></figure>

<p>第六步：快速的恢复数据库中的数据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rm -rf /mysql_3306/data/*</span></span><br><span class="line"><span class="comment"># innobackupex --copy-back /full_xtrabackup/2020-08-29_15-59-22</span></span><br></pre></td></tr></table></figure>

<p>第一次恢复报错：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innobackupex version <span class="number">2.4</span>.<span class="number">7</span> based on MySQL server <span class="number">5.7</span>.<span class="number">13</span> Linux (x86_64) (revision id: <span class="number">05</span>f1fcf)</span><br><span class="line">Error: datadir must be specified.</span><br></pre></td></tr></table></figure>

<p>出现以上问题的主要原因在于，innobackupex工具无法找到MySQL中的数据目录</p>
<p>解决方案：把my.cnf配置文件传递给innobackupex，让其自动识别这个文件中的datadir</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex --defaults-file=/mysql_3306/my.cnf --copy-back /full_xtrabackup/2020-08-29_15-59-22</span></span><br></pre></td></tr></table></figure>

<p>第七步：恢复数据时，一定要记得更改&#x2F;mysql_3306&#x2F;data目录下的文件拥有者以及所属组权限，否则mysql无法启动</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chown -R mysql.mysql /mysql_3306/data</span></span><br></pre></td></tr></table></figure>

<p>第八步：启动MySQL，测试其是否正常</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service mysql_3306 start</span></span><br><span class="line"><span class="comment"># mysql -p</span></span><br><span class="line">Enter password:<span class="number">123</span></span><br></pre></td></tr></table></figure>

<h2 id="5、xtrabackup增量备份与恢复"><a href="#5、xtrabackup增量备份与恢复" class="headerlink" title="5、xtrabackup增量备份与恢复"></a>5、xtrabackup增量备份与恢复</h2><p>什么是增量？增量一定要有一个前提，必须要先有一个全量。</p>
<p><img src="/../assets/blog_res/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.assets/image-20200829165632567.png" alt="image-20200829165632567"></p>
<p>① 全量备份</p>
<p>② 把全量备份产生的日志整合到全量备份</p>
<p>③ 进行数据的增删改操作</p>
<p>④ 增量备份</p>
<p>⑤ 把增量备份及增量备份产生的日志文件全部整合到全量备份中</p>
<p>⑥ 模拟故障</p>
<p>⑦ 数据恢复</p>
<p>⑧ 启动数据库，测试验证数据</p>
<p>第一步：准备数据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database db_itheima default charset=utf8;</span><br><span class="line">mysql&gt; use db_itheima;</span><br><span class="line">mysql&gt; create table t1(id int,name varchar(<span class="number">10</span>)) engine=myisam;</span><br><span class="line">mysql&gt; insert into t1 values (<span class="number">1</span>,<span class="string">&#x27;吕布&#x27;</span>);</span><br><span class="line">mysql&gt; create table t2(id int,name varchar(<span class="number">10</span>)) engine=innodb;</span><br><span class="line">mysql&gt; insert into t2 values (<span class="number">1</span>,<span class="string">&#x27;貂蝉&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>第二步：创建一个账号，专门用于备份</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">创建备份用户admin，并授予相应权限</span><br><span class="line">mysql&gt; grant reload,<span class="keyword">process</span>,lock tables,replication client on *.* to <span class="string">&#x27;admin&#x27;</span><span class="string">@&#x27;localhost&#x27; identified by &#x27;123&#x27;;</span></span><br><span class="line"><span class="string">mysql&gt; flush privileges;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">说明：</span></span><br><span class="line"><span class="string">在数据库中需要以下权限：</span></span><br><span class="line"><span class="string">RELOAD和LOCK TABLES权限:为了执行FLUSH TABLES WITH READ LOCK</span></span><br><span class="line"><span class="string">REPLICATION CLIENT权限：为了获取binary log位置</span></span><br><span class="line"><span class="string">PROCESS权限：显示有关在服务器中执行的线程的信息（即有关会话执行的语句的信息），允许使用SHOW ENGINE</span></span><br></pre></td></tr></table></figure>

<p>第三步：全量备份</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rm -rf /full_xtrabackup/*</span></span><br><span class="line"><span class="comment"># innobackupex --user=admin --password=123 /full_xtrabackup</span></span><br></pre></td></tr></table></figure>

<p>第四步：把全备过程中产生的日志进行整合（特别注意）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex --user=admin --password=123 --apply-log --redo-only /full_xtrabackup/2020-08-29_17-06-48/</span></span><br><span class="line"></span><br><span class="line">选项说明：</span><br><span class="line"><span class="literal">--apply-log</span> 表示整合日志</span><br><span class="line"><span class="literal">--redo-only</span>	表示只应用已经提交的事务，不回滚未提交的事务（<span class="number">12</span>:<span class="number">00</span> ~ <span class="number">12</span>:<span class="number">30</span>产生很多事务操作，事务处理=&gt;开启事务，成功了提交事务，写入硬盘；失败了回滚事务，不写入硬盘）</span><br><span class="line">注意：如果已经回滚了未提交事务，那么就无法再应用增量备份。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  Preparing an Incremental Backup with innobackupex Preparing incremental backups is a bit different than full ones. This is, perhaps, the stage where more attention is needed:<br>  • First, only the committed transactions must be replayed on each backup. This will merge the base full backup with the incremental ones.<br>  • Then, the uncommitted transaction must be rolled back in order to have a ready-to-use backup.<br>  对于增量备份的Prepare阶段，有2个需要注意的地方，一个是提交的事务需要replayed，一个未提交的事务需要rollback。</p>
<p>  If you replay the committed transactions and rollback the uncommitted ones on the base backup, you will not be able to add the incremental ones. If you do this on an incremental one, you won’t be able to add data from that moment and the remaining increments. Having this in mind, the procedure is very straight-forward using the –redo-only option, starting with the base backup:<br>  如果在Prepare阶段replay了已提交的事务以及回滚了未提交的事务，则后续的增量备份无法添加到当前全备。因此在Prepare阶段全备应使用–redo-only选项。</p>
<p>  –redo-only should be used when merging all incrementals except the last one. That’s why the previous line doesn’t contain the –redo-only option. Even if the –redo-only was used on the last step, backup would still be consistent but in that case server would perform the rollback phase.<br>  对于存在多次增量的情形，仅仅只有最后一个增量不需要使用–redo-only 选项。如果使用了的话，rollback将由服务器启动的时候来完成。</p>
</blockquote>
<p>第五步：修改数据（进行增删改操作，让其产生增量数据）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql -p</span></span><br><span class="line">Enter password:<span class="number">123</span></span><br><span class="line">mysql&gt; insert into db_itheima.t1 values (<span class="number">2</span>,<span class="string">&#x27;王朗&#x27;</span>);</span><br><span class="line">mysql&gt; insert into db_itheima.t1 values (<span class="number">3</span>,<span class="string">&#x27;袁术&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>第六步：做增量备份</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex --user=admin --password=123 --incremental /incre_backup --incremental-basedir=/full_xtrabackup/2020-08-29_17-06-48</span></span><br><span class="line"></span><br><span class="line">选项说明：</span><br><span class="line"><span class="literal">--incremental</span> 增量备份目录</span><br><span class="line"><span class="literal">--incremental-basedir</span> 这个增量是相对于哪个全量的</span><br></pre></td></tr></table></figure>

<p>第七步：把增量备份产生的数据以及日志文件整合到全量备份中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex --user=admin --password=123 --apply-log /full_xtrabackup/2020-08-29_17-06-48 --incremental-dir=/incre_backup/2020-08-29_17-23-43</span></span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line"><span class="number">1</span>.<span class="literal">--redo-only</span>除了最后一个不用加之外，其他的增量应用都要加，最后一个应用的时候可以直接进入回滚未提交事务阶段;如果加了也没事，服务启动的时候会进入recovery过程，来回滚</span><br><span class="line"><span class="number">2</span>.应用增量备份的时候只能按照备份的顺序来应用。如果应用顺序错误，那么备份就不可用。如果无法确定顺序，可以使用xtra<span class="built_in">backup-checkpoints</span>来确定顺序。</span><br><span class="line"></span><br><span class="line">周天做了一个全量，周一、周二、周三、周四、周五、周六全部做增量</span><br></pre></td></tr></table></figure>

<p>到此，增量备份就全部结束了！</p>
<p>第八步：模拟数据库故障</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rm -rf /mysql_3306/data/*</span></span><br><span class="line"><span class="comment"># pkill mysqld</span></span><br></pre></td></tr></table></figure>

<p>第九步：数据恢复</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># innobackupex --defaults-file=/mysql_3306/my.cnf --user=admin --password=123 --copy-back /full_xtrabackup/2020-08-29_17-06-48</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chown -R mysql.mysql /mysql_3306/data</span></span><br></pre></td></tr></table></figure>

<p>启动数据库，测试验证是否正常</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service mysql_3306 start</span></span><br><span class="line"><span class="comment"># mysql -p</span></span><br><span class="line">Enter password:<span class="number">123</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://sesaananta.github.io">Sesa·Ananta</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://sesaananta.github.io/posts/7105.html">http://sesaananta.github.io/posts/7105.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://sesaananta.github.io" target="_blank">舍沙の窝</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/linux/">linux</a><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post_share"><div class="social-share" data-image="/img/%E5%A4%B4%E5%83%8F.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/13613.html" title="MySQL主从复制架构"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL主从复制架构</div></div></a></div><div class="next-post pull-right"><a href="/posts/139.html" title="MySQL备份与恢复（重点）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL备份与恢复（重点）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/13613.html" title="MySQL主从复制架构"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="title">MySQL主从复制架构</div></div></a></div><div><a href="/posts/30031.html" title="MySQL介绍及安装"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="title">MySQL介绍及安装</div></div></a></div><div><a href="/posts/53323.html" title="MySQL基本SQL语句（上）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="title">MySQL基本SQL语句（上）</div></div></a></div><div><a href="/posts/11338.html" title="MySQL基本SQL语句（下）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="title">MySQL基本SQL语句（下）</div></div></a></div><div><a href="/posts/139.html" title="MySQL备份与恢复（重点）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="title">MySQL备份与恢复（重点）</div></div></a></div><div><a href="/posts/16175.html" title="半同步复制与MHA高可用架构设计"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="title">半同步复制与MHA高可用架构设计</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Sesa·Ananta</div><div class="author-info__description">一介愚人，但求无悔</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/SesaAnanta/SesaAnanta.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/SesaAnanta/SesaAnanta.github.io" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://space.bilibili.com/7820821" target="_blank" title="BiliBili"><i class="fab fa-bilibili" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1874121517@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到一介愚人、网络乞丐、无业游民、扑街写手的个人博客，此处记录闲言碎语，断章同人，学习笔记以及一些无用的努力</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">1.</span> <span class="toc-text">MySQL备份与恢复</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD"><span class="toc-number">2.</span> <span class="toc-text">一、逻辑备份</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%9B%9E%E9%A1%BE%E4%BB%80%E4%B9%88%E6%98%AF%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD"><span class="toc-number">2.1.</span> <span class="toc-text">1、回顾什么是逻辑备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.</span> <span class="toc-text">2、逻辑备份工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E9%80%BB%E8%BE%91%E7%9A%84%E5%AF%BC%E5%87%BA%E4%B8%8E%E5%AF%BC%E5%85%A5"><span class="toc-number">2.3.</span> <span class="toc-text">3、逻辑的导出与导入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%98%86-%E5%AF%BC%E5%87%BA%EF%BC%88%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%EF%BC%89"><span class="toc-number">2.3.1.</span> <span class="toc-text">☆ 导出（数据备份）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%98%86-%E5%AF%BC%E5%85%A5%EF%BC%88%E6%95%B0%E6%8D%AE%E8%BF%98%E5%8E%9F%EF%BC%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">☆ 导入（数据还原）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%89%A9%E5%B1%95%EF%BC%9A%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F%E5%B0%8F%E5%B7%A5%E5%85%B7%EF%BC%88%E6%94%AF%E6%8C%81%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">4、扩展：逻辑备份还原小工具（支持远程连接）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%89%A9%E7%90%86%E5%A4%87%E4%BB%BD"><span class="toc-number">3.</span> <span class="toc-text">二、物理备份</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81xtrabackup%E5%A4%87%E4%BB%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">1、xtrabackup备份介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%8E%B7%E5%8F%96xtrabackup%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7"><span class="toc-number">3.2.</span> <span class="toc-text">2、获取xtrabackup备份工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81xtabackup%E8%BD%AF%E4%BB%B6%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.</span> <span class="toc-text">3、xtabackup软件的安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81xtrabackup%E5%85%A8%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">3.4.</span> <span class="toc-text">4、xtrabackup全库备份与恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81xtrabackup%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">3.5.</span> <span class="toc-text">5、xtrabackup增量备份与恢复</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/16107.html" title="Hello World">Hello World</a><time datetime="2024-01-16T14:31:05.465Z" title="发表于 2024-01-16 22:31:05">2024-01-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/9eb9.html" title="博客搭建参考">博客搭建参考</a><time datetime="2024-01-16T02:05:45.000Z" title="发表于 2024-01-16 10:05:45">2024-01-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/51833.html" title="博客搭建心得">博客搭建心得</a><time datetime="2024-01-15T02:41:40.000Z" title="发表于 2024-01-15 10:41:40">2024-01-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/41553.html" title="Overlord-15">Overlord-15</a><time datetime="2024-01-11T02:48:04.000Z" title="发表于 2024-01-11 10:48:04">2024-01-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/25232.html" title="Overlord-14">Overlord-14</a><time datetime="2024-01-10T12:52:31.000Z" title="发表于 2024-01-10 20:52:31">2024-01-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Sesa·Ananta</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="/js/tw_cn.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="19820015" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,和谐,友爱,文明,自由,平等,公正,爱国,敬业,友善,法治" data-fontsize="15px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = '0335690119134f7ca9dbca5c57f0e2df';
  var gaud_map_key = 'ab1d5683f1f29c69e79c4dd768c9c2bb';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '109.979035,21.342844';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>